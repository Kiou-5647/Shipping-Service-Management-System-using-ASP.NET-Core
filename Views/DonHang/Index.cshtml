@using Shipping.Models.Enums
@model IEnumerable<Shipping.Models.DonHang>

@{
    ViewData["Title"] = "Danh sách đơn hàng";
}

<div class="container-fluid px-4 pb-5">

    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Quản lý Đơn hàng</h1>
            <p class="text-muted small mb-0">Hiển thị danh sách toàn bộ vận đơn trong hệ thống</p>
        </div>
        <a asp-action="Create" class="btn btn-primary shadow-sm">
            <i class="fas fa-plus me-1"></i> Tạo đơn mới
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body p-2">
            <div class="row g-2">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Tìm theo mã đơn, SĐT..." onkeyup="searchTable()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter" onchange="filterStatus()">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option value="ChoXuLy">Chờ xử lý</option>
                        <option value="DangGiao">Đang giao</option>
                        <option value="DaGiao">Đã giao</option>
                        <option value="ThatBai">Thất bại/Hủy</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="ordersTable">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3">Mã đơn / Ngày</th>
                            <th>Hành trình</th>
                            <th>Dịch vụ</th>
                            <th class="text-end">Tổng thu / TT</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Tác vụ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold text-primary">
                                            <a asp-action="Details" asp-route-id="@item.Id" class="text-decoration-none">#@item.Id</a>
                                        </div>
                                        <small class="text-muted"><i class="far fa-clock me-1"></i>@item.NgayTao.ToString("dd/MM/yy HH:mm")</small>
                                    </td>

                                    <td style="min-width: 250px;">
                                        <div class="d-flex align-items-start mb-2">
                                            <div class="badge bg-white text-secondary border border-secondary me-2 mt-1 shadow-sm"
                                                 style="min-width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;">
                                                G
                                            </div>
                                            <div class="lh-sm">
                                                <span class="d-block fw-bold text-dark">
                                                    @item.TTNguoiGui?.Split('-')[0]
                                                </span>
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                                    @item.TinhThanhGui?.TenTinhThanh
                                                </small>
                                            </div>
                                        </div>

                                        <div class="d-flex align-items-start">
                                            <div class="badge bg-success text-white border border-success me-2 mt-1 shadow-sm"
                                                 style="min-width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;">
                                                N
                                            </div>
                                            <div class="lh-sm">
                                                <span class="d-block fw-bold text-dark">
                                                    @item.TTNguoiNhan?.Split('-')[0]
                                                </span>
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt text-success me-1"></i>
                                                    @item.TinhThanhNhan?.TenTinhThanh
                                                </small>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info rounded-pill">
                                            @item.LoaiDichVu?.TenDichVu
                                        </span>
                                    </td>

                                    <td class="text-end">
                                        <div class="fw-bold text-dark">@item.ThanhTien.ToString("N0") ₫</div>
                                        @if (item.TrangThaiTT == TrangThaiThanhToan.DaThanhToan)
                                        {
                                            <small class="text-success fw-bold"><i class="fas fa-check-circle"></i> Đã TT</small>
                                        }
                                        else
                                        {
                                            <small class="text-warning text-dark"><i class="fas fa-history"></i> Chờ TT</small>
                                        }
                                    </td>

                                    <td class="text-center">
                                        @{
                                            string statusClass = item.TrangThaiDH switch
                                            {
                                                TrangThaiDonHang.ChoXuLy => "bg-warning text-dark",
                                                TrangThaiDonHang.DangGiao => "bg-primary",
                                                TrangThaiDonHang.DaGiao => "bg-success",
                                                TrangThaiDonHang.ThatBai => "bg-danger",
                                                _ => "bg-secondary"
                                            };
                                        }
                                        <span class="badge @statusClass rounded-pill px-3 py-2" data-status-raw="@item.TrangThaiDH">
                                            @Html.DisplayFor(m => item.TrangThaiDH)
                                        </span>
                                    </td>

                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </a>

                                            @if (item.TrangThaiDH == TrangThaiDonHang.ChoXuLy)
                                            {
                                                <form asp-action="DeleteOrder" asp-route-id="@item.Id" method="post" class="d-inline" onsubmit="return confirm('Bạn có chắc chắn muốn xóa đơn hàng @item.Id? Hành động này không thể hoàn tác!');">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa đơn hàng">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <img src="https://cdn-icons-png.flaticon.com/512/4076/4076432.png" width="60" class="mb-3 opacity-50">
                                    <p class="text-muted">Chưa có dữ liệu đơn hàng nào.</p>
                                    <a asp-action="Create" class="btn btn-sm btn-outline-primary">Tạo đơn ngay</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white py-3">
            <div class="small text-muted">Hiển thị @Model?.Count() bản ghi</div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Hàm tìm kiếm
        function searchTable() {
            var input = document.getElementById("searchInput");
            var filter = input.value.toUpperCase();
            var table = document.getElementById("ordersTable");
            var tr = table.getElementsByTagName("tr");

            for (var i = 1; i < tr.length; i++) {
                var tdId = tr[i].getElementsByTagName("td")[0];
                var tdName = tr[i].getElementsByTagName("td")[1];

                if (tdId || tdName) {
                    var txtValueId = tdId.textContent || tdId.innerText;
                    var txtValueName = tdName.textContent || tdName.innerText;

                    if (txtValueId.toUpperCase().indexOf(filter) > -1 || txtValueName.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        // Hàm lọc trạng thái
        function filterStatus() {
            var select = document.getElementById("statusFilter");
            var filter = select.value;
            var table = document.getElementById("ordersTable");
            var tr = table.getElementsByTagName("tr");

            for (var i = 1; i < tr.length; i++) {
                if(filter === "") {
                    tr[i].style.display = "";
                    continue;
                }
                var badge = tr[i].querySelector("span[data-status-raw]");
                if (badge) {
                    var status = badge.getAttribute("data-status-raw");
                    if (status === filter) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    </script>
}